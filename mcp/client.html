<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>caddr.org iframe communication</title>
  </head>
  <body>
    <h1>CADDR-MCP Client</h1>
    <iframe
      id="caddrFrame"
      frameborder="0"
      style="width: 300px; height: 80px"
    ></iframe>

    <br />

    <div id="dataBox"></div>

    <form id="form">
      <input type="text" id="prompt" />
    </form>

    <script src="api.js"></script>

    <script>
      const servers = {};

      document
        .getElementById("form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const prompt = document.getElementById("prompt").value;
          const tools = Object.fromEntries(
            Object.entries(servers).flatMap(([server, info]) =>
              info.tools.map((tool) => [
                tool.name,
                {
                  server,
                  info: tool,
                },
              ])
            )
          );
          const toolSchema = Object.values(tools).map((tool) => tool.info);
          console.log(prompt, toolSchema);
          // toolSchema[0] eg: {
          //   name: "get_stock_price",
          //   description:
          //     "Get the current stock price for a given ticker symbol.",
          //   input_schema: {
          //     type: "object",
          //     properties: {
          //       ticker: {
          //         type: "string",
          //         description:
          //           "The stock ticker symbol, e.g. AAPL for Apple Inc.",
          //       },
          //     },
          //     required: ["ticker"],
          //   },
          // },
          const tool = tools[toolSchema[0].name];
          try {
            const result = await RPC(tool.server, tool.info.name, {
              ticker: "AAPL",
            });
            console.log("result", result);
          } catch (err) {
            console.log("error", error);
          }
        });

      const requestHandlers = {
        async addServer(sender, data) {
          console.log("addServer", sender, data);
          servers[sender.from] = data;
          console.log(
            "Server Info",
            sender.fromOrigin,
            data.name,
            data.version
          );
          console.log("servers", servers);
        },
        async onConnect() {
          hideAuthorizationFrame();
          const allServers = await RPC("*", "listMethods");
          for (let info of allServers) {
            console.log(
              "Server Info",
              info.fromOrigin,
              info.result.name,
              info.result.version
            );
            servers[info.from] = info.result;
          }
          console.log("servers", servers);
        },
      };
    </script>
  </body>
</html>
